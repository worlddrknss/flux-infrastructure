stages: [maintenance]

flux-bootstrap:
  <<: *aws-login
  image: alpine:3.20
  stage: maintenance
  before_script:
    - *aws-login
    # Install Flux CLI
    - curl -s https://fluxcd.io/install.sh | bash
    # Load cluster name from Terraform artifact
    - export EKS_CLUSTER_NAME=$(cat scripts/terraform/cluster_name)
    # Update kubeconfig
    - aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$TF_STATE_REGION"
  script:
    - flux check --pre
    - >
      flux bootstrap gitlab \
        --owner="$CI_PROJECT_NAMESPACE" \
        --repository="$CI_PROJECT_NAME" \
        --branch=main \
        --path=flux/clusters/${EKS_CLUSTER_NAME} \
        --token-auth

include:
  - local: .gitlab/workflows/.gitlab-ci.templates.yml
