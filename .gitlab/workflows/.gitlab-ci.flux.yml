include:
  - local: .gitlab/workflows/.gitlab-ci.templates.yml

stages: [maintenance]

flux-bootstrap:
  extends: .flux-job
  stage: maintenance
  script:
    - export EKS_CLUSTER_NAME=$(cat scripts/terraform/cluster_name)
    - aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$TF_STATE_REGION"
    - flux check --pre
    - >
      flux bootstrap gitlab \
        --owner="$CI_PROJECT_NAMESPACE" \
        --repository="$CI_PROJECT_NAME" \
        --branch=main \
        --path=flux/clusters/${EKS_CLUSTER_NAME} \
        --token-auth
  rules:
    - when: manual
