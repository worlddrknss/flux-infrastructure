stages:
  - test
  - secret-detection
  - validate
  - plan
  - apply
  - destroy

variables:
  TF_ROOT: "scripts/terraform"

sast:
  stage: test

secret_detection:
  stage: secret-detection

# -----------------------------
# Terraform Job Template
# -----------------------------
.terraform-job:
  image:
    name: hashicorp/terraform:1.13.0
    entrypoint: ["/usr/bin/env", "sh", "-c"]   # reset entrypoint so GitLab can run scripts normally
  before_script:
    - export AWS_ROLE_ARN=$AWS_ROLE_ARN
    - export AWS_WEB_IDENTITY_TOKEN_FILE=$CI_JOB_JWT_FILE
    - aws sts get-caller-identity
    - cd "$TF_ROOT"
    - terraform init \
        -backend-config="bucket=$TF_STATE_BUCKET" \
        -backend-config="key=$TF_STATE_KEY" \
        -backend-config="region=$TF_STATE_REGION" \
        -backend-config="dynamodb_table=$TF_STATE_LOCK_TABLE" \
        -backend-config="encrypt=true"

# -----------------------------
# Terraform Jobs
# -----------------------------
validate:
  extends: .terraform-job
  stage: validate
  script:
    - cd "$TF_ROOT"
    - terraform fmt -check
    - terraform validate
  rules:
    - changes:
        - scripts/terraform/**/*
    - when: never

plan:
  extends: .terraform-job
  stage: plan
  script:
    - cd "$TF_ROOT"
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - scripts/terraform/tfplan
    expire_in: 1h
  dependencies:
    - validate

apply:
  extends: .terraform-job
  stage: apply
  script:
    - cd "$TF_ROOT"
    - terraform apply -auto-approve tfplan
  dependencies:
    - plan
  when: manual

destroy:
  extends: .terraform-job
  stage: destroy
  script:
    - cd "$TF_ROOT"
    - terraform destroy -auto-approve
  when: manual

# -----------------------------
# GitLab Security Templates
# -----------------------------
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/SAST-IaC.latest.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
